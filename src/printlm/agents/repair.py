from typing import (
    Any,
    Dict,
    List, 
)

from printlm.agents.base import BaseAgent
from printlm.prompts.repair.models import RepairPrompt
from printlm.prompts.task.models import TaskPrompt


class RepairAgent(BaseAgent):
    """
    Repair agent class.
    """
    def __init__(
        self, 
        llm: Any,
        model_id: str, 
        **model_args,
    ) -> None:
        super().__init__(llm, model_id)
        self.model_args = model_args

    def _get_prompt(
        self,
        repair_prompt: RepairPrompt,
        task_prompt: TaskPrompt,
        initial_code: str,
        feedback: str,
    ) -> List[Dict[str, str]]:
        """
        Get the (zero shot) prompt for the (chat) model.
        """
        messages = [
            {"role": repair_prompt.role, "content": repair_prompt.content},
            {"role": task_prompt.role, "content": f"{task_prompt.content} + \n + ### INCORRECT PYTHON CODE + \n {initial_code} + \n + ### FEEDBACK + \n {feedback}"},
        ]
        return messages

    def _get_response(self,
        messages: List[Dict[str, str]],
        ) -> Any:
        """
        Get the response from the model.
        """
        response = self.llm(messages=messages, **self.model_args)
        return response
    
    def run(
        self, 
        repair_prompt: RepairPrompt,
        task_prompt: TaskPrompt,
        initial_code: str,
        feedback: str,
    ) -> Dict[str, Any]:
        """Runs the Repair Agent

        Args:
            repair_prompt (feedbackPrompt): The feedback prompt to use
            task_prompt (TaskPrompt): The task prompt to use
            initial_code (str): The initial code generated by the CodeAgent
            feedback (str): The feedback from the FeedbackAgent

        Returns:
            A dictionary containing the repair model's response and the cost of the performed API call
        """
        # Get the prompt
        messages = self._get_prompt(repair_prompt=repair_prompt, task_prompt=task_prompt, initial_code=initial_code, feedback=feedback)
        # Get the response
        response = self._get_response(messages=messages)
        # Get Cost
        cost = self.calc_cost(response=response)

        return {
            'response': response,
            'response_str': response.choices[0].message.content,
            'cost': cost
        }